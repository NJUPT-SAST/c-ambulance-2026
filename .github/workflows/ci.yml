name: CI/CD Pipeline

# ============================================================================
# CI/CD Pipeline for React + Next.js + Tauri Application
# ============================================================================
#
# This workflow runs automatically on pushes and pull requests.
# It works OUT-OF-THE-BOX without requiring any secrets to be configured.
#
# OPTIONAL SECRETS (for enhanced features - DISABLED by default):
# ----------------------------------------------------------------
#
# For Codecov Integration (optional, commented out):
#   - CODECOV_TOKEN: Token from codecov.io
#
# For Vercel Deployments (optional, commented out):
#   - VERCEL_TOKEN: Vercel deployment token
#   - VERCEL_ORG_ID: Vercel organization ID
#   - VERCEL_PROJECT_ID: Vercel project ID
#
# For macOS Code Signing (optional, DISABLED by default):
#   - APPLE_CERTIFICATE: Base64-encoded .p12 certificate
#   - APPLE_CERTIFICATE_PASSWORD: Certificate password
#   - APPLE_SIGNING_IDENTITY: Developer ID Application identity
#   - APPLE_ID: Apple ID email
#   - APPLE_PASSWORD: App-specific password
#   - APPLE_TEAM_ID: Apple Developer Team ID
#
# For Windows Code Signing (optional, DISABLED by default):
#   - WINDOWS_CERTIFICATE: Base64-encoded PFX certificate
#   - WINDOWS_CERTIFICATE_PASSWORD: Certificate password
#
# âš ï¸ CODE SIGNING IS DISABLED BY DEFAULT - Tauri builds will be unsigned.
# To enable code signing, uncomment the relevant sections in the workflow.
# All features that require secrets will be skipped gracefully if not configured.
# See CI_CD.md for detailed setup instructions.
# ============================================================================

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs when a new workflow with the same group name is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Code Quality Checks (runs in parallel with tests)
  quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display CI/CD Configuration
        shell: bash
        # All optional integrations are disabled by default
        # Uncomment the env section below to enable status checks for optional features
        # env:
        #   CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        #   VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        #   VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        #   VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        #   APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        #   WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
        run: |
          echo "## ðŸ”§ CI/CD Configuration" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Optional Features Status:" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "âšª All optional integrations are **DISABLED** by default" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Optional features (currently disabled):" >> "$GITHUB_STEP_SUMMARY"
          echo "- Codecov integration" >> "$GITHUB_STEP_SUMMARY"
          echo "- Vercel deployments" >> "$GITHUB_STEP_SUMMARY"
          echo "- macOS code signing" >> "$GITHUB_STEP_SUMMARY"
          echo "- Windows code signing" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "â„¹ï¸ To enable optional features:" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Add the required secrets to your GitHub repository" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Uncomment the relevant sections in \`.github/workflows/ci.yml\`" >> "$GITHUB_STEP_SUMMARY"
          echo "3. See \`CI_CD.md\` for detailed setup instructions" >> "$GITHUB_STEP_SUMMARY"

          # Uncomment the following sections to enable status checks for optional features:
          #
          # if [ -n "${CODECOV_TOKEN}" ]; then
          #   echo "âœ… Codecov integration: **Enabled**" >> "$GITHUB_STEP_SUMMARY"
          # else
          #   echo "âšª Codecov integration: **Disabled** (CODECOV_TOKEN not configured)" >> "$GITHUB_STEP_SUMMARY"
          # fi
          #
          # if [ -n "${VERCEL_TOKEN}" ] && [ -n "${VERCEL_ORG_ID}" ] && [ -n "${VERCEL_PROJECT_ID}" ]; then
          #   echo "âœ… Vercel deployments: **Enabled**" >> "$GITHUB_STEP_SUMMARY"
          # else
          #   echo "âšª Vercel deployments: **Disabled** (Vercel secrets not configured)" >> "$GITHUB_STEP_SUMMARY"
          # fi
          #
          # if [ -n "${APPLE_CERTIFICATE}" ]; then
          #   echo "âœ… macOS code signing: **Enabled**" >> "$GITHUB_STEP_SUMMARY"
          # else
          #   echo "âšª macOS code signing: **Disabled** (Apple certificates not configured)" >> "$GITHUB_STEP_SUMMARY"
          # fi
          #
          # if [ -n "${WINDOWS_CERTIFICATE}" ]; then
          #   echo "âœ… Windows code signing: **Enabled**" >> "$GITHUB_STEP_SUMMARY"
          # else
          #   echo "âšª Windows code signing: **Disabled** (Windows certificate not configured)" >> "$GITHUB_STEP_SUMMARY"
          # fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm lint
        continue-on-error: true

      - name: TypeScript type checking
        run: pnpm exec tsc --noEmit

      - name: Security audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated dependencies
        run: pnpm outdated
        continue-on-error: true

  # Job 2: Test Suite
  test:
    name: Test Suite
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      checks: write

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for better coverage comparison

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "pnpm"

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Generate coverage summary
        if: always()
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tail -n 10 coverage/lcov-report/index.html | grep -oP '(?<=<div class="pad1">).*?(?=</div>)' | head -1 || echo "Coverage report generated" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      # Optional: Upload coverage to Codecov (requires CODECOV_TOKEN secret)
      # Uncomment the following steps to enable Codecov integration:
      # 1. Sign up at https://codecov.io and get your CODECOV_TOKEN
      # 2. Add CODECOV_TOKEN to your GitHub repository secrets
      # 3. Uncomment the steps below
      #
      # - name: Upload coverage reports to Codecov
      #   uses: codecov/codecov-action@v4
      #   env:
      #     CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      #   if: ${{ (github.event_name == 'pull_request' || github.ref == 'refs/heads/main') && env.CODECOV_TOKEN != '' }}
      #   with:
      #     token: ${{ env.CODECOV_TOKEN }}
      #     files: ./coverage/lcov.info
      #     flags: unittests
      #     name: codecov-umbrella
      #     fail_ci_if_error: false
      #   continue-on-error: true
      #
      # - name: Code Coverage Report
      #   uses: irongut/CodeCoverageSummary@v1.3.0
      #   if: github.event_name == 'pull_request'
      #   with:
      #     filename: coverage/cobertura-coverage.xml
      #     badge: true
      #     fail_below_min: false
      #     format: markdown
      #     hide_branch_rate: false
      #     hide_complexity: true
      #     indicators: true
      #     output: both
      #     thresholds: '60 80'
      #   continue-on-error: true
      #
      # - name: Add Coverage PR Comment
      #   uses: marocchino/sticky-pull-request-comment@v2
      #   if: github.event_name == 'pull_request'
      #   with:
      #     recreate: true
      #     path: code-coverage-results.md
      #   continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: coverage/junit.xml
          retention-days: 30

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always() && github.event_name == 'pull_request'
        with:
          files: |
            coverage/junit.xml
          check_name: Test Results
          comment_title: Test Results
        continue-on-error: true

      - name: Build Next.js application
        run: pnpm build

      - name: Check bundle size
        if: github.event_name == 'pull_request'
        run: |
          echo "## Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Output Directory Size" >> $GITHUB_STEP_SUMMARY
          du -sh out/ >> $GITHUB_STEP_SUMMARY || echo "Build output size check skipped" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: out/
          retention-days: 7

      - name: Store build size
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p .github/size-snapshot
          du -sb out/ | cut -f1 > .github/size-snapshot/build-size.txt
        continue-on-error: true

  # Job 3: Deploy Preview (Optional - requires Vercel secrets)
  # DISABLED by default - uncomment to enable Vercel preview deployments
  # To enable:
  # 1. Add VERCEL_TOKEN, VERCEL_ORG_ID, and VERCEL_PROJECT_ID to GitHub secrets
  # 2. Uncomment the entire job below
  # 3. See CI_CD.md for detailed setup instructions
  #
  # deploy-preview:
  #   name: Deploy Preview
  #   needs: [quality, test]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: nextjs-build
  #         path: out/
  #
  #     - name: Deploy to Vercel Preview
  #       uses: amondnet/vercel-action@v25
  #       env:
  #         VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
  #         VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  #         VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
  #       if: ${{ env.VERCEL_TOKEN != '' && env.VERCEL_ORG_ID != '' && env.VERCEL_PROJECT_ID != '' }}
  #       with:
  #         vercel-token: ${{ env.VERCEL_TOKEN }}
  #         vercel-org-id: ${{ env.VERCEL_ORG_ID }}
  #         vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
  #         working-directory: ./
  #       continue-on-error: true
  #
  #     - name: Comment Preview URL
  #       uses: actions/github-script@v7
  #       with:
  #         script: |
  #           github.rest.issues.createComment({
  #             issue_number: context.issue.number,
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             body: 'ðŸš€ Preview deployment is ready! Check the deployment status above.'
  #           })
  #       continue-on-error: true

  # Job 4: Deploy to Production (DISABLED BY DEFAULT)
  #
  # âš ï¸ PRODUCTION DEPLOYMENT IS DISABLED BY DEFAULT âš ï¸
  #
  # To enable production deployments:
  # 1. Set up GitHub Environment protection rules:
  #    - Go to Settings > Environments > Create "production" environment
  #    - Add required reviewers for manual approval
  #    - Optionally add deployment branch restrictions
  #
  # 2. Configure required secrets in GitHub:
  #    - VERCEL_TOKEN: Your Vercel deployment token
  #    - VERCEL_ORG_ID: Your Vercel organization ID
  #    - VERCEL_PROJECT_ID: Your Vercel project ID
  #
  # 3. Uncomment the job below and update the environment URL
  #
  # 4. Consider adding additional conditions:
  #    - Require specific labels on commits
  #    - Only deploy on tagged releases
  #    - Add time-based deployment windows
  #
  # deploy-production:
  #   name: Deploy to Production
  #   needs: [quality, test]
  #   runs-on: ubuntu-latest
  #
  #   # Requires manual approval via GitHub Environments
  #   environment:
  #     name: production
  #     url: https://your-app-url.com
  #
  #   # Only run on main branch pushes (additional safety)
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: nextjs-build
  #         path: out/
  #
  #     - name: Deploy to Vercel Production
  #       uses: amondnet/vercel-action@v25
  #       with:
  #         vercel-token: ${{ secrets.VERCEL_TOKEN }}
  #         vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
  #         vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
  #         vercel-args: '--prod'
  #         working-directory: ./
  #
  #     - name: Create deployment summary
  #       run: |
  #         echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
  #         echo "" >> $GITHUB_STEP_SUMMARY
  #         echo "âœ… Successfully deployed to production" >> $GITHUB_STEP_SUMMARY
  #         echo "ðŸ“… Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY
  #         echo "ðŸ”— Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
  #         echo "ðŸŒ URL: https://your-app-url.com" >> $GITHUB_STEP_SUMMARY

  # Job 5: Build Tauri Desktop Application
  build-tauri:
    name: Build Tauri App (${{ matrix.platform }})
    needs: [quality, test]

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch: amd64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
          - platform: macos-latest
            target: x86_64-apple-darwin
            arch: x64
          - platform: macos-latest
            target: aarch64-apple-darwin
            arch: arm64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"
          cache-on-failure: true

      - name: Install system dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      # Note: Code signing is OPTIONAL and DISABLED by default.
      # Unsigned builds are suitable for testing and development.
      # For production releases with code signing, uncomment the env section below
      # and configure the appropriate secrets for your platform.
      #
      # To enable code signing:
      # 1. Add the required secrets to your GitHub repository
      # 2. Uncomment the env section below
      # 3. For macOS: Add APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD, APPLE_SIGNING_IDENTITY, APPLE_ID, APPLE_PASSWORD, APPLE_TEAM_ID
      # 4. For Windows: Add WINDOWS_CERTIFICATE, WINDOWS_CERTIFICATE_PASSWORD
      - name: Build Tauri app
        # env:
        #   # Optional: macOS code signing (only used if secrets are configured)
        #   APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        #   APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        #   APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
        #   APPLE_ID: ${{ secrets.APPLE_ID }}
        #   APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
        #   APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        #   # Optional: Windows code signing (only used if secrets are configured)
        #   WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
        #   WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          pnpm tauri build --target ${{ matrix.target }}
        continue-on-error: false

      - name: Upload Linux artifacts (AppImage)
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-linux-${{ matrix.arch }}-appimage
          path: src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Linux artifacts (deb)
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-linux-${{ matrix.arch }}-deb
          path: src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Windows artifacts (MSI)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-windows-${{ matrix.arch }}-msi
          path: src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
          retention-days: 30
          if-no-files-found: warn

      - name: Upload Windows artifacts (NSIS)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-windows-${{ matrix.arch }}-nsis
          path: src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
          retention-days: 30
          if-no-files-found: warn

      - name: Upload macOS artifacts (DMG)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-macos-${{ matrix.arch }}-dmg
          path: src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
          retention-days: 30
          if-no-files-found: warn

      - name: Upload macOS artifacts (App)
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: tauri-macos-${{ matrix.arch }}-app
          path: src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          retention-days: 30
          if-no-files-found: warn

  # Job 6: Create GitHub Release (only on tags)
  create-release:
    name: Create Release
    needs: [quality, test, build-tauri]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/**/*.AppImage
            artifacts/**/*.deb
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
